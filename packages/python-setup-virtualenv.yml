---

- name: installation and configuration of virtualenv and django
  hosts: all
  become: true
  tasks:
    
    - name: install git if not installed
      apt: 
        name: git
        state: present

    - name: Install virtual env
      pip:
        name: virtualenv
    
    - name: create app directory
      file:
        path: "{{app_root_directory}}"
        state: directory

    - name: git clone repository
      git:
        repo: git@gitlab.com:Griessmeister/mikenskiet.git
        dest: "{{app_root_directory}}"
        clone: yes

    - name: "create virataul env"
      command: 
        chdir: "{{app_root_directory}}"
        cmd: virtualenv "{{virtualenv_name}}"

    - name: apt install default-libmysqlclient-dev
      apt:
        name: default-libmysqlclient-dev
        state: present

    - name: install packages for django env
      pip:
        virtualenv: "{{app_root_directory}}/{{virtualenv_name}}"
        name: ["django","gunicorn","mysqlclient"]
    
    - name:
      pip:
          requirements: "{{app_root_directory}}/requirements.txt"
          virtualenv: "{{app_root_directory}}/{{virtualenv_name}}"
    
    - name: "check that provisioning script exist"
      stat:
        path: "{{app_root_directory}}/tr069server/scripts/provisioner.py"
      register: provisioning_script 

    - name: "run provisioning script every 5 minutes"
      cron:
        name: "Provisioning device"
        minute: "*/5"
        state: present
        hour: "*"
        day: "*"
        job: "{{app_root_directory}}/{{virtualenv_name}}/bin/python3 {{app_root_directory}}/tr069server/scripts/provisioner.py"
      when: provisioning_script.stat.exists == True
          